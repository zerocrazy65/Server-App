"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const chai_1 = require("chai");
const Crypter_1 = require("../src/crypter/Crypter");
const FixedLength_1 = require("../src/crypter/FixedLength");
const DatabaseType_1 = require("../src/DatabaseType");
const HttpsError_1 = require("../src/HttpsError");
const logger_1 = require("../src/logger");
const ParameterBuilder_1 = require("../src/parameter/ParameterBuilder");
const ParameterContainer_1 = require("../src/parameter/ParameterContainer");
const ParameterParser_1 = require("../src/parameter/ParameterParser");
function expectHttpsError(execute, code) {
    try {
        execute();
    }
    catch (error) {
        (0, chai_1.expect)(error).to.have.ownProperty('httpErrorCode');
        (0, chai_1.expect)(error).to.have.ownProperty('code');
        (0, chai_1.expect)(error.code).to.be.equal(code);
        return;
    }
    chai_1.expect.fail('Expected to throw an error.');
}
class StringClassType {
    value;
    constructor(value) {
        this.value = value;
    }
}
(function (StringClassType) {
    function fromString(value, logger) {
        if (value !== 'v1' && value !== 'v2' && value !== 'v3')
            throw (0, HttpsError_1.HttpsError)('internal', '', logger);
        return new StringClassType(value);
    }
    StringClassType.fromString = fromString;
})(StringClassType || (StringClassType = {}));
class NumberClassType {
    value;
    constructor(value) {
        this.value = value;
    }
}
(function (NumberClassType) {
    function fromNumber(value) {
        return new NumberClassType(value);
    }
    NumberClassType.fromNumber = fromNumber;
})(NumberClassType || (NumberClassType = {}));
class ObjectClassType {
    v1;
    v2;
    constructor(v1, v2) {
        this.v1 = v1;
        this.v2 = v2;
    }
}
(function (ObjectClassType) {
    function fromObject(value, logger) {
        if (value === null)
            throw (0, HttpsError_1.HttpsError)('internal', '', logger);
        if (!('v1' in value) || typeof value.v1 !== 'string')
            throw (0, HttpsError_1.HttpsError)('internal', '', logger);
        if (!('v2' in value) || typeof value.v2 !== 'number')
            throw (0, HttpsError_1.HttpsError)('internal', '', logger);
        return new ObjectClassType(value.v1, value.v2);
    }
    ObjectClassType.fromObject = fromObject;
})(ObjectClassType || (ObjectClassType = {}));
describe('ParameterParser', () => {
    const cryptionKeys = {
        encryptionKey: new FixedLength_1.FixedLength(Uint8Array.from([0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x1A, 0x1B, 0x1C, 0x1D, 0x1E, 0x1F]), 32),
        initialisationVector: new FixedLength_1.FixedLength(Uint8Array.from([0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F]), 16),
        vernamKey: new FixedLength_1.FixedLength(Uint8Array.from([0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x1A, 0x1B, 0x1C, 0x1D, 0x1E, 0x1F]), 32)
    };
    const logger = logger_1.Logger.start(new logger_1.VerboseType('coloredVerbose'), 'parameter parser test');
    function testParameterParser(parameterToParse, builders, expectedParameters) {
        const crypter = new Crypter_1.Crypter(cryptionKeys);
        const parameterContainer = new ParameterContainer_1.ParameterContainer({
            databaseType: new DatabaseType_1.DatabaseType('testing'),
            parameters: crypter.encodeEncrypt(parameterToParse)
        }, (databaseType) => {
            return {
                cryptionKeys: cryptionKeys,
                callSecretKey: '',
                databaseUrl: ''
            };
        }, logger.nextIndent);
        const parameterParser = new ParameterParser_1.ParameterParser(builders, logger.nextIndent);
        parameterParser.parseParameters(parameterContainer);
        (0, chai_1.expect)(parameterParser.parameters).to.be.deep.equal(expectedParameters);
    }
    it('get parameter before parsing', () => {
        expectHttpsError(() => {
            const parameterParser = new ParameterParser_1.ParameterParser({
                value: ParameterBuilder_1.ParameterBuilder.value('string')
            }, logger.nextIndent);
            parameterParser.parameters;
        }, 'internal');
    });
    it('empty parameter', () => {
        testParameterParser({}, {}, {
            databaseType: new DatabaseType_1.DatabaseType('testing')
        });
    });
    it('only primitive types and object', () => {
        testParameterParser({
            value1: 'asdf',
            value2: 12,
            value3: {
                subValue1: 'ghjk',
                subValue2: 98
            }
        }, {
            value1: ParameterBuilder_1.ParameterBuilder.value('string'),
            value2: ParameterBuilder_1.ParameterBuilder.value('number'),
            value3: ParameterBuilder_1.ParameterBuilder.value('object')
        }, {
            value1: 'asdf',
            value2: 12,
            value3: {
                subValue1: 'ghjk',
                subValue2: 98
            },
            databaseType: new DatabaseType_1.DatabaseType('testing')
        });
    });
    it('only builders', () => {
        testParameterParser({
            value1: 'v1',
            value2: 12.50,
            value3: {
                v1: 'a',
                v2: 3
            }
        }, {
            value1: ParameterBuilder_1.ParameterBuilder.build('string', StringClassType.fromString),
            value2: ParameterBuilder_1.ParameterBuilder.build('number', NumberClassType.fromNumber),
            value3: ParameterBuilder_1.ParameterBuilder.build('object', ObjectClassType.fromObject)
        }, {
            value1: new StringClassType('v1'),
            value2: new NumberClassType(12.50),
            value3: new ObjectClassType('a', 3),
            databaseType: new DatabaseType_1.DatabaseType('testing')
        });
    });
    it('primitive types, object and builders', () => {
        testParameterParser({
            value1: 23.9,
            value2: 'v3'
        }, {
            value1: ParameterBuilder_1.ParameterBuilder.value('number'),
            value2: ParameterBuilder_1.ParameterBuilder.build('string', StringClassType.fromString)
        }, {
            value1: 23.9,
            value2: new StringClassType('v3'),
            databaseType: new DatabaseType_1.DatabaseType('testing')
        });
    });
    it('builder throws', () => {
        try {
            testParameterParser({
                value1: 'invalid'
            }, {
                value1: ParameterBuilder_1.ParameterBuilder.build('string', StringClassType.fromString)
            }, {
                value1: new StringClassType('v1'),
                databaseType: new DatabaseType_1.DatabaseType('testing')
            });
            (0, chai_1.expect)(true).to.be.false;
        }
        catch (error) {
            (0, chai_1.expect)(error).to.have.ownProperty('code');
            (0, chai_1.expect)(error.code).to.be.equal('internal');
        }
    });
    it('also parse database type', () => {
        testParameterParser({
            value1: 'as',
            databaseType: 'testing'
        }, {
            value1: ParameterBuilder_1.ParameterBuilder.value('string'),
            databaseType: ParameterBuilder_1.ParameterBuilder.build('string', DatabaseType_1.DatabaseType.fromString)
        }, {
            value1: 'as',
            databaseType: new DatabaseType_1.DatabaseType('testing')
        });
    });
    it('guard builder', () => {
        testParameterParser({
            value: 'b'
        }, {
            value: ParameterBuilder_1.ParameterBuilder.guard('string', (value) => value === 'a' || value === 'b')
        }, {
            value: 'b',
            databaseType: new DatabaseType_1.DatabaseType('testing')
        });
    });
    it('optional builder', () => {
        testParameterParser({
            value1a: 12,
            value1b: undefined,
            value2a: 'a',
            value2b: undefined,
            value3a: 'testing',
            value3b: undefined,
            value4a: undefined,
            value4b: null
        }, {
            value1a: ParameterBuilder_1.ParameterBuilder.optional(ParameterBuilder_1.ParameterBuilder.value('number')),
            value1b: ParameterBuilder_1.ParameterBuilder.optional(ParameterBuilder_1.ParameterBuilder.value('number')),
            value2a: ParameterBuilder_1.ParameterBuilder.optional(ParameterBuilder_1.ParameterBuilder.guard('string', (value) => value === 'a' || value === 'b')),
            value2b: ParameterBuilder_1.ParameterBuilder.optional(ParameterBuilder_1.ParameterBuilder.guard('string', (value) => value === 'a' || value === 'b')),
            value3a: ParameterBuilder_1.ParameterBuilder.optional(ParameterBuilder_1.ParameterBuilder.build('string', DatabaseType_1.DatabaseType.fromString)),
            value3b: ParameterBuilder_1.ParameterBuilder.optional(ParameterBuilder_1.ParameterBuilder.build('string', DatabaseType_1.DatabaseType.fromString)),
            value4a: ParameterBuilder_1.ParameterBuilder.optional(ParameterBuilder_1.ParameterBuilder.build('undefined', (value) => value)),
            value4b: ParameterBuilder_1.ParameterBuilder.optional(ParameterBuilder_1.ParameterBuilder.build('undefined', (value) => value))
        }, {
            value1a: 12,
            value1b: undefined,
            value2a: 'a',
            value2b: undefined,
            value3a: new DatabaseType_1.DatabaseType('testing'),
            value3b: undefined,
            value4a: undefined,
            value4b: undefined,
            databaseType: new DatabaseType_1.DatabaseType('testing')
        });
    });
    it('invalid type', () => {
        expectHttpsError(() => {
            testParameterParser({
                value: 'asdf'
            }, {
                value: new ParameterBuilder_1.ParameterBuilder(['number'], v => v.toString())
            }, {
                value: 'asdf',
                databaseType: new DatabaseType_1.DatabaseType('testing')
            });
        }, 'invalid-argument');
    });
    it('invalid undefined type', () => {
        expectHttpsError(() => {
            testParameterParser({
                value: undefined
            }, {
                value: new ParameterBuilder_1.ParameterBuilder(['number'], v => v.toString())
            }, {
                value: 'asdf',
                databaseType: new DatabaseType_1.DatabaseType('testing')
            });
        }, 'invalid-argument');
    });
    it('failed guard builder', () => {
        expectHttpsError(() => {
            testParameterParser({
                value: 'c'
            }, {
                value: ParameterBuilder_1.ParameterBuilder.guard('string', (value) => value === 'a' || value === 'b')
            }, {
                value: 'a',
                databaseType: new DatabaseType_1.DatabaseType('testing')
            });
        }, 'invalid-argument');
    });
});
